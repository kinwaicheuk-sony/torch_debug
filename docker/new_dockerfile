FROM nvidia/cuda:12.1.0-base-ubuntu20.04

# Install system dependencies
RUN apt-get update && \
    apt-get install -y wget && \
    rm -rf /var/lib/apt/lists/*

# Install Miniforge
RUN wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh && \
    bash Miniforge3-Linux-x86_64.sh -b -p /root/miniforge3 && \
    rm -f Miniforge3-Linux-x86_64.sh

# Add conda to PATH
ENV PATH="/root/miniforge3/bin:${PATH}"

# Initialize conda
RUN conda init bash && \
    echo "export PATH=/root/miniforge3/bin:${PATH}" >> /root/.bashrc && \
    conda --version


# Install PyTorch packages first with the extra index URL
RUN pip install --no-cache-dir \
    torch==2.2.2 \
    torchvision==0.17.2 \
    torchaudio==2.2.2 \
    --extra-index-url https://download.pytorch.org/whl/cu121

# Install other dependencies
RUN pip install --no-cache-dir \
    tensorboard==2.17.0 \
    pytorch-lightning==2.3.1 \
    torchmetrics==0.11.4 \
    hydra-core==1.3.2 \
    numpy==1.26.4

# Set working directory
WORKDIR /workspace

# Default command
CMD ["/bin/bash"]

# This image has the size of 5.63GB.
